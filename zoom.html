<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zoom + Slow/Speed Org√¢nico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
button { padding:12px 22px; font-size:18px; border:none; border-radius:10px; cursor:pointer; color:#fff; background:var(--dourado); margin:10px; box-shadow:0 6px 16px rgba(0,0,0,.25);}
video { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; transform-origin:center center; }
#status { min-height:48px; margin:12px 0; font-weight:600; }
#qrCode { width:200px; height:200px; margin:20px auto; display:grid; place-items:center; border:2px solid var(--dourado); border-radius:12px; }
</style>
</head>
<body>

<h2>üé¨ Zoom + Slow/Speed Org√¢nico</h2>
<button id="startBtn">‚ñ∂Ô∏è Iniciar Grava√ß√£o</button>

<video id="mainVideo" autoplay muted playsinline></video>
<canvas id="videoCanvas" style="display:none;"></canvas>

<div id="status">‚è≥ Aguardando in√≠cio...</div>
<div id="qrCode"></div>

<script>
const startBtn = document.getElementById('startBtn');
const mainVideo = document.getElementById('mainVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
const qrBox = document.getElementById('qrCode');

const cloudName = 'dxobnhynf';
const uploadPreset = 'plataforma_360';

let mediaRecorder, chunks = [];
let stream;
let animFrame;
let recording = false;

// --- QR Code ---
function makeQR(url){
  qrBox.innerHTML = '';
  new QRCode(qrBox, { text:url, width:200, height:200, correctLevel:QRCode.CorrectLevel.H });
}

// --- Inicializa c√¢mera ---
async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
  mainVideo.srcObject = stream;
  await mainVideo.play();
  canvas.width = mainVideo.videoWidth || 640;
  canvas.height = mainVideo.videoHeight || 480;
}

// --- Zoom org√¢nico mais r√°pido/profundo ---
let zoomScale = 1;
let zoomDirection = 0.008; // dobramos a velocidade do zoom
function getZoom(){ 
  zoomScale += zoomDirection; 
  if(zoomScale > 2 || zoomScale < 1) zoomDirection *= -1; // zoom mais profundo
  return zoomScale;
}

// --- Slow/Speed org√¢nico mais extremo ---
function getSpeedFactor(){
  // de 0.3x (bem lento) at√© 3x (bem r√°pido)
  return 0.3 + Math.random() * 2.7;
}

// --- Desenha no canvas ---
function drawFrame(){
  if(!recording) return;

  const scale = getZoom();
  const speedFactor = getSpeedFactor();

  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const w = canvas.width * scale;
  const h = canvas.height * scale;
  const dx = (canvas.width - w)/2;
  const dy = (canvas.height - h)/2;

  ctx.drawImage(mainVideo, dx, dy, w, h);
  ctx.restore();

  // ajusta tempo do pr√≥ximo frame conforme fator de velocidade
  animFrame = setTimeout(()=>requestAnimationFrame(drawFrame), (33 / speedFactor));
}

// --- Inicia grava√ß√£o ---
function startRecording(){
  chunks = [];
  recording = true;

  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream, { mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.onstop = uploadVideo;
  mediaRecorder.start();

  drawFrame();
  statusDiv.textContent = 'üî¥ Gravando...';
  startBtn.disabled = true;

  // grava por 20 segundos
  setTimeout(stopRecording, 20000);
}

// --- Para grava√ß√£o ---
function stopRecording(){
  recording = false;
  clearTimeout(animFrame);
  mediaRecorder.stop();
  statusDiv.textContent = '‚è≥ Enviando v√≠deo...';
  startBtn.textContent = '‚ñ∂Ô∏è Novo V√≠deo';
  startBtn.disabled = false;
}

// --- Upload para Cloudinary ---
async function uploadVideo(){
  const blob = new Blob(chunks,{type:'video/webm'});
  const formData = new FormData();
  formData.append('file',blob);
  formData.append('upload_preset',uploadPreset);

  try{
    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, { method:'POST', body: formData });
    const data = await res.json();
    if(!res.ok || data.error) throw new Error(data?.error?.message || ('HTTP '+res.status));
    const url = data.secure_url;
    statusDiv.innerHTML = `‚úÖ V√≠deo enviado!<br><a href="${url}" target="_blank">Abrir v√≠deo</a>`;
    makeQR(url);
  }catch(err){
    statusDiv.textContent = '‚ùå Erro ao enviar v√≠deo: '+err.message;
  }
}

// --- Bot√£o iniciar/reiniciar ---
startBtn.onclick = async ()=>{
  if(!stream) await initCamera();
  startRecording();
};
</script>
</body>
</html>
